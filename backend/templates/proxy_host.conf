{% include "_header_comment.conf" %}

{% if enabled %}
server {
  set $forward_scheme {{ forward_scheme }};
  set $server         "{{ forward_host }}";
  set $port           {{ forward_port }};

{% include "_listen.conf" %}
{% include "_certificates.conf" %}
{% include "_hsts.conf" %}
{% include "_forced_ssl.conf" %}

  include conf.d/include/letsencrypt-acme-challenge.conf;
  include conf.d/include/block-exploits.conf;

{{ advanced_config }}
  
{% if use_default_location %}
  location / {
    include conf.d/include/letsencrypt-acme-challenge.conf;

    {% if access_list_id > 0 %}
    {% if access_list.items.length > 0 %}
    {{ access_list.passauth }}
    {% endif %}
    {% endif %}

    {% if allow_websocket_upgrade == 1 or allow_websocket_upgrade == true %}
    proxy_set_header Upgrade            $http_upgrade;
    proxy_set_header Connection         $connection_upgrade;
    {% endif %}

    # Proxy!
    include conf.d/include/proxy.conf;
  }
{% endif %}

  {% if access_list_id > 0 %}
  {% if access_list.items.length > 0 %}
  # Authorization
  auth_basic            "Authorization required";
  auth_basic_user_file  /data/access/{{ access_list_id }};
 
  {{ access_list.passauth }}
  {% endif %}
 
  # Access Rules
  {% for client in access_list.clients %}
  {{- client.rule -}};
  {% endfor %}deny all;
 
  # Access checks must...
  {% if access_list.satisfy %}
  {{ access_list.satisfy }};
  {% endif %}
 
  {% endif %}

{{ locations }}

  # Custom
  include /data/nginx/custom/server_proxy.conf;
}
{% endif %}
