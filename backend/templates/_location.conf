{% assign path_last_char = path | slice: -1 -%}

{% if path != "/" and path_last_char == "/" %}
location {{ path | remove_last: "/" }} {
    absolute_redirect off;
    return 301 {{ path }}/;
}
{% endif %}

location {{ path }} {
  set $forward_scheme "{{ forward_scheme }}";
  set $server         "{{ forward_host }}";
  set $port           "{{ forward_port }}";
  set $forward_path   "{{ forward_path }}";
  
  {{ advanced_config }}
    
  {% if allow_websocket_upgrade %}
  proxy_http_version 1.1;
  proxy_set_header Upgrade    $http_upgrade;
  proxy_set_header Connection $connection_upgrade;
  {% endif %}

  include conf.d/include/proxy-headers.conf;
  proxy_pass {{ forward_scheme }}://{{ forward_host }}{% if forward_port != null %}:{{ forward_port }}{% endif %}{{ forward_path }}{% if forward_path == null %}$request_uri{% endif %};
}
